<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.demo.mapper.ChatMessageMapper">

  <!-- 메시지 저장 -->
  <insert id="insertMessage" parameterType="com.example.demo.domain.ChatMessage"
          useGeneratedKeys="true" keyProperty="cmId">
    INSERT INTO CHAT_MESSAGE
      (room_type, room_id, user_id, message_type, content, image_url, is_deleted, created_at)
    VALUES
      (#{roomType}, #{roomId}, #{userId}, #{messageType}, #{content}, #{imageUrl}, false, NOW())
  </insert>

  <!-- 메시지 목록 조회 (afterId 이후 것만 + limit 개) -->
  <select id="findMessages" resultType="com.example.demo.domain.ChatMessage">
    SELECT *
    FROM CHAT_MESSAGE
    WHERE room_type = #{roomType}
      AND room_id = #{roomId}
      AND is_deleted = false
      <if test="afterId != null and afterId &gt; 0">
        AND cm_id &gt; #{afterId}
      </if>
    ORDER BY cm_id ASC
    LIMIT #{limit}
  </select>

</mapper>
